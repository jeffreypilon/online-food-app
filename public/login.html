<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Online Food App</title>
    <link href="css/tailwind.css" rel="stylesheet">
</head>
<body class="flex flex-col min-h-screen bg-gray-50">
    <!-- Header Inclusion -->
    <div id="header-container"></div>
    <script>
        fetch('/header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-container').innerHTML = data;
            })
            .catch(error => {
                console.error('Error loading header:', error);
                document.getElementById('header-container').innerHTML = '<p class="text-red-500 p-4">Error loading header</p>';
            });
    </script>
    
    <div class="flex flex-grow mt-16 mb-16">
        <!-- Left Navigation Bar -->
        <div id="left-nav-container"></div>
        <script>
            fetch('/left-nav-bar.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('left-nav-container').innerHTML = data;
                })
                .catch(error => {
                    console.error('Error loading left navigation bar:', error);
                    document.getElementById('left-nav-container').innerHTML = '<p class="text-red-500 p-4">Error loading navigation</p>';
                });
        </script>
        
        <main class="flex-grow container mx-auto py-10 px-4 ml-64">
            <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-md">
                <div class="text-center mb-8">
                    <h1 class="font-bold text-2xl text-gray-800">Welcome back!</h1>
                    <p class="text-gray-600 mt-2">Enter your email address and password to access admin panel</p>
                </div>
                
                <form class="space-y-6" id="loginForm" novalidate>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                        <input type="email" id="email" name="email" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               required
                               pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$">
                        <p id="emailError" class="text-red-500 text-sm mt-1 hidden">Email address must be valid and include the @ symbol.</p>
                    </div>
                    
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="password" name="password" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               required
                               minlength="8"
                               maxlength="20">
                        <p id="passwordError" class="text-red-500 text-sm mt-1 hidden">Password must be 8-20 characters long and include 1 number and 1 special character.</p>
                    </div>
                    
                    <div class="flex space-x-4 pt-2">
                        <button type="submit" 
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                            Login
                        </button>
                        <button type="reset" 
                                class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-200">
                            Reset
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>
    
    <!-- Footer Inclusion -->
    <div id="footer-container"></div>
    <script>
        fetch('/footer.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('footer-container').innerHTML = data;
            })
            .catch(error => {
                console.error('Error loading footer:', error);
                document.getElementById('footer-container').innerHTML = '<p class="text-red-500 p-4">Error loading footer</p>';
            });
    </script>

    <!-- Form validation script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('loginForm');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const emailError = document.getElementById('emailError');
            const passwordError = document.getElementById('passwordError');

            // Function to validate email
            function validateEmail(email) {
                const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                return emailRegex.test(email);
            }

            // Function to validate password
            function validatePassword(password) {
                // Check length
                if (password.length < 8 || password.length > 20) {
                    return false;
                }

                // Check for at least one number
                const hasNumber = /[0-9]/.test(password);
                
                // Check for at least one special character
                const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
                
                return hasNumber && hasSpecial;
            }

            // Real-time validation for email
            emailInput.addEventListener('input', function() {
                if (validateEmail(emailInput.value)) {
                    emailInput.classList.remove('border-red-500');
                    emailInput.classList.add('border-green-500');
                    emailError.classList.add('hidden');
                } else {
                    emailInput.classList.remove('border-green-500');
                    emailInput.classList.add('border-red-500');
                    emailError.classList.remove('hidden');
                }
            });

            // Real-time validation for password
            passwordInput.addEventListener('input', function() {
                if (validatePassword(passwordInput.value)) {
                    passwordInput.classList.remove('border-red-500');
                    passwordInput.classList.add('border-green-500');
                    passwordError.classList.add('hidden');
                } else {
                    passwordInput.classList.remove('border-green-500');
                    passwordInput.classList.add('border-red-500');
                    passwordError.classList.remove('hidden');
                }
            });

            // Form submission validation
            loginForm.addEventListener('submit', function(event) {
                event.preventDefault(); // Always prevent default to handle manually
                
                let isValid = true;
                
                // Validate email
                if (!validateEmail(emailInput.value)) {
                    emailError.classList.remove('hidden');
                    emailInput.classList.add('border-red-500');
                    isValid = false;
                }
                
                // Validate password
                if (!validatePassword(passwordInput.value)) {
                    passwordError.classList.remove('hidden');
                    passwordInput.classList.add('border-red-500');
                    isValid = false;
                }
                
                // If form is valid, submit data to server
                if (isValid) {
                    // Prepare data for sending
                    const userData = {
                        email: emailInput.value,
                        password: passwordInput.value
                    };
                    
                    // Send POST request to auth route
                    fetch('/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userData)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Login failed');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Login successful
                            console.log('Login successful:', data);
                            // Store user info if needed
                            localStorage.setItem('user', JSON.stringify({
                                email: data.data.email,
                                name: data.data.name,
                                role: data.data.role
                            }));
                            // Redirect to home or dashboard
                            window.location.href = '/';
                        } else {
                            // Login failed with server validation error
                            throw new Error(data.message || 'Login failed');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        
                        // Remove any existing login error message
                        const existingError = document.getElementById('loginError');
                        if (existingError) {
                            existingError.remove();
                        }
                        
                        // Create error message with same styling as validation errors
                        const loginError = document.createElement('p');
                        loginError.id = 'loginError';
                        loginError.className = 'text-red-500 text-sm mt-4';
                        loginError.textContent = `Login failed: ${error.message}`;
                        
                        // Add error message after the form buttons
                        const buttonContainer = loginForm.querySelector('.flex.space-x-4');
                        buttonContainer.parentNode.insertBefore(loginError, buttonContainer.nextSibling);
                    });
                }
            });

            // Reset validation on form reset
            loginForm.addEventListener('reset', function() {
                emailInput.classList.remove('border-red-500', 'border-green-500');
                passwordInput.classList.remove('border-red-500', 'border-green-500');
                emailError.classList.add('hidden');
                passwordError.classList.add('hidden');
            });
        });
    </script>
</body>
</html>
