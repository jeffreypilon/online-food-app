<header class="bg-blue-600 text-white shadow-md fixed top-0 left-0 right-0 z-50">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold">Online Food Ordering Application</h1>
        <nav>
            <ul class="flex space-x-6">
                <li><a href="/" class="hover:underline">Home</a></li>
                <li><a href="/menu" class="hover:underline">Menu</a></li>
                <li>
                    <a href="/cart" class="hover:underline flex items-center">
                        Cart <span id="cart-count" class="ml-1 bg-red-500 text-white text-xs rounded-full px-2 py-1 hidden">0</span>
                    </a>
                </li>
                <li id="auth-link"><a href="/login" class="hover:underline">Login</a></li>
            </ul>
        </nav>
    </div>
</header>

<script>
    // Check authentication status when the header loads
    document.addEventListener('DOMContentLoaded', function() {
        const authLink = document.getElementById('auth-link');
        
        // First check if there's a user in localStorage (client-side)
        const localUser = localStorage.getItem('user');
        
        if (localUser) {
            // User data in localStorage, show logout
            updateToLogoutLink(authLink);
        } else {
            // If not in localStorage, check session on server
            fetch('/auth/me')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Not authenticated');
                })
                .then(data => {
                    if (data.success && data.data) {
                        // User is in session, save to localStorage and show logout
                        localStorage.setItem('user', JSON.stringify(data.data));
                        updateToLogoutLink(authLink);
                    }
                })
                .catch(error => {
                    console.log('User not authenticated:', error.message);
                    // User not authenticated, ensure login link is shown
                    updateToLoginLink(authLink);
                });
        }
        
        // Update cart count
        updateCartCount();
    });
    
    // Update cart count from session storage
    function updateCartCount() {
        try {
            const savedCart = sessionStorage.getItem('cart');
            if (savedCart) {
                const cartData = JSON.parse(savedCart);
                const cartCount = cartData.items.reduce((total, item) => total + item.quantity, 0);
                
                const cartCountElement = document.getElementById('cart-count');
                if (cartCountElement && cartCount > 0) {
                    cartCountElement.textContent = cartCount;
                    cartCountElement.classList.remove('hidden');
                }
            }
        } catch (error) {
            console.error('Error loading cart count:', error);
        }
    }
    
    // Helper function to update to logout link
    function updateToLogoutLink(element) {
        element.innerHTML = '<a href="#" id="logout-btn" class="hover:underline">Logout</a>';
        
        // Add event listener after updating the DOM
        document.getElementById('logout-btn').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Call logout API
            fetch('/auth/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Clear user data from localStorage
                localStorage.removeItem('user');
                
                // Update link back to login
                updateToLoginLink(element);
                
                // Redirect to home page
                window.location.href = '/';
            })
            .catch(error => {
                console.error('Logout failed:', error);
            });
        });
    }
    
    // Helper function to update to login link
    function updateToLoginLink(element) {
        element.innerHTML = '<a href="/login" class="hover:underline">Login</a>';
    }
</script>
