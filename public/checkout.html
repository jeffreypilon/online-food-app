<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Online Food App</title>
    <link href="css/tailwind.css" rel="stylesheet">
</head>
<body class="flex flex-col min-h-screen bg-gray-50">
    <!-- Header Inclusion -->
    <div id="header-container"></div>
    <script>
        fetch('/header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-container').innerHTML = data;
            })
            .catch(error => {
                console.error('Error loading header:', error);
                document.getElementById('header-container').innerHTML = '<p class="text-red-500 p-4">Error loading header</p>';
            });
    </script>

    <div class="flex flex-grow mt-16 mb-16">
        <!-- Left Navigation Bar -->
        <div id="left-nav-container"></div>
        <script>
            fetch('/left-nav-bar.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('left-nav-container').innerHTML = data;
                })
                .catch(error => {
                    console.error('Error loading left navigation bar:', error);
                    document.getElementById('left-nav-container').innerHTML = '<p class="text-red-500 p-4">Error loading navigation</p>';
                });
        </script>

        <!-- Main content - add ml-64 class to align with other pages -->
        <main class="flex-grow container mx-auto py-10 px-4 ml-64">
            <h1 class="text-3xl font-bold text-gray-800 mb-8">Checkout</h1>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Order Summary -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-bold mb-4">Order Summary</h2>
                        
                        <div id="order-summary" class="space-y-4 mb-6">
                            <p class="text-gray-500 text-center">Loading order summary...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Checkout Form -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-bold mb-6">Delivery Information</h2>
                        
                        <form id="checkout-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                                    <input type="text" id="firstName" name="firstName" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                </div>
                                <div>
                                    <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                                    <input type="text" id="lastName" name="lastName" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                </div>
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                    <input type="email" id="email" name="email" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                </div>
                                <div>
                                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                                    <input type="tel" id="phone" name="phone" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Delivery Address</label>
                                <input type="text" id="address" name="address" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            </div>
                            
                            <h2 class="text-xl font-bold mb-6">Payment Method</h2>
                            
                            <div class="space-y-4 mb-6">
                                <div class="flex items-center">
                                    <input type="radio" id="creditCard" name="paymentMethod" value="creditCard" class="mr-2" checked>
                                    <label for="creditCard">Credit Card</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="paypal" name="paymentMethod" value="paypal" class="mr-2">
                                    <label for="paypal">PayPal</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="cashOnDelivery" name="paymentMethod" value="cashOnDelivery" class="mr-2">
                                    <label for="cashOnDelivery">Cash on Delivery</label>
                                </div>
                            </div>
                            
                            <div class="flex justify-between">
                                <a href="/cart" class="bg-gray-200 text-gray-800 px-6 py-2 rounded hover:bg-gray-300 transition">
                                    Back to Cart
                                </a>
                                <button type="submit" id="place-order-btn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
                                    Place Order
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer -->
    <div id="footer-container"></div>
    <script>
        fetch('/footer.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('footer-container').innerHTML = data;
            })
            .catch(error => {
                console.error('Error loading footer:', error);
                document.getElementById('footer-container').innerHTML = '<p class="text-red-500 p-4">Error loading footer</p>';
            });
    </script>

    <!-- Checkout JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if cart exists in sessionStorage
            const savedCart = sessionStorage.getItem('cart');
            if (!savedCart) {
                // Redirect to cart page if no cart exists
                window.location.href = '/cart';
                return;
            }
            
            try {
                // Parse cart data
                const cartData = JSON.parse(savedCart);
                const cartItems = cartData.items || [];
                
                if (cartItems.length === 0) {
                    // Redirect to cart page if cart is empty
                    window.location.href = '/cart';
                    return;
                }
                
                // Load menu item details for each cart item
                const itemPromises = cartItems.map(item => {
                    return fetch(`/api/menu-items/${item.id}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                return {
                                    ...data.data,
                                    quantity: item.quantity
                                };
                            }
                            throw new Error(`Failed to load item ${item.id}`);
                        });
                });
                
                // Wait for all item details to be fetched
                Promise.all(itemPromises)
                    .then(items => {
                        // Render order summary
                        renderOrderSummary(items);
                        
                        // Pre-fill form if user is logged in
                        populateUserInfo();
                        
                        // Set up form submission
                        setupCheckoutForm(items);
                    })
                    .catch(error => {
                        console.error('Error loading order items:', error);
                        alert('Error loading your order. Please try again.');
                        window.location.href = '/cart';
                    });
            } catch (error) {
                console.error('Error parsing cart data:', error);
                alert('Error loading your cart. Please try again.');
                window.location.href = '/cart';
            }
        });
        
        // Function to render order summary
        function renderOrderSummary(items) {
            const orderSummary = document.getElementById('order-summary');
            
            // Calculate subtotal
            const subtotal = items.reduce((total, item) => {
                return total + (item.price * item.quantity);
            }, 0);
            
            // Fixed delivery fee
            const deliveryFee = 3.99;
            
            // Calculate total
            const total = subtotal + deliveryFee;
            
            // Generate HTML for order summary
            let summaryHTML = '';
            
            // Add each item
            items.forEach(item => {
                const itemTotal = item.price * item.quantity;
                summaryHTML += `
                    <div class="flex justify-between">
                        <span>${item.name} x${item.quantity}</span>
                        <span>$${itemTotal.toFixed(2)}</span>
                    </div>
                `;
            });
            
            // Add subtotal, delivery fee, and total
            summaryHTML += `
                <div class="border-t border-gray-200 pt-4">
                    <div class="flex justify-between font-medium">
                        <span>Subtotal</span>
                        <span>$${subtotal.toFixed(2)}</span>
                    </div>
                </div>
                <div class="flex justify-between">
                    <span>Delivery Fee</span>
                    <span>$${deliveryFee.toFixed(2)}</span>
                </div>
                <div class="flex justify-between font-bold text-lg border-t border-gray-200 pt-4">
                    <span>Total</span>
                    <span>$${total.toFixed(2)}</span>
                </div>
            `;
            
            // Update the order summary element
            orderSummary.innerHTML = summaryHTML;
        }
        
        // Function to populate user information if available
        function populateUserInfo() {
            fetch('/auth/me')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Not authenticated');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.data) {
                        // Pre-fill form with user data
                        const user = data.data;
                        
                        if (user.firstName) {
                            document.getElementById('firstName').value = user.firstName;
                        }
                        
                        if (user.lastName) {
                            document.getElementById('lastName').value = user.lastName;
                        }
                        
                        if (user.email) {
                            document.getElementById('email').value = user.email;
                        }
                    }
                })
                .catch(error => {
                    console.log('User not authenticated:', error.message);
                    // Not authenticated, form will be empty
                });
        }
        
        // Function to set up checkout form submission
        function setupCheckoutForm(items) {
            const checkoutForm = document.getElementById('checkout-form');
            
            checkoutForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                // Get form data
                const formData = new FormData(checkoutForm);
                const orderData = {
                    customerInfo: {
                        firstName: formData.get('firstName'),
                        lastName: formData.get('lastName'),
                        email: formData.get('email'),
                        phone: formData.get('phone'),
                        address: formData.get('address')
                    },
                    paymentMethod: formData.get('paymentMethod'),
                    items: items.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity
                    })),
                    subtotal: items.reduce((total, item) => total + (item.price * item.quantity), 0),
                    deliveryFee: 3.99,
                    total: items.reduce((total, item) => total + (item.price * item.quantity), 0) + 3.99
                };
                
                // Send order to server
                fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Clear cart from sessionStorage
                        sessionStorage.removeItem('cart');
                        
                        // Show success message
                        alert('Order placed successfully! Your order number is: ' + data.data.id);
                        
                        // Redirect to confirmation page or home
                        window.location.href = '/';
                    } else {
                        throw new Error(data.message || 'Failed to place order');
                    }
                })
                .catch(error => {
                    console.error('Error placing order:', error);
                    alert('Error placing your order: ' + error.message);
                });
            });
        }
    </script>
</body>
</html>
